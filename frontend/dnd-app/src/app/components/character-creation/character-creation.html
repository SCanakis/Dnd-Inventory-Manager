<div class="character-creation-container">
  <!-- Header -->
  <div class="header">
    <h1>Create New Character</h1>
    <button class="btn btn-secondary" (click)="cancel()">‚Üê Back to Characters</button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Loading character creation data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Error</h3>
    <p>{{ errorMessage }}</p>
    <button class="btn btn-primary" (click)="loadInitialData()">Try Again</button>
  </div>

  <!-- Character Creation Form -->
  <div *ngIf="!isLoading && !errorMessage" class="creation-form">
    
    <!-- Basic Information -->
    <div class="section">
      <h2>Basic Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="characterName">Character Name *</label>
          <input 
            id="characterName"
            type="text" 
            [(ngModel)]="characterDTO.name"
            placeholder="Enter character name"
            class="form-input"
          />
        </div>
      </div>
    </div>

    <!-- Background Selection -->
    <div class="section">
      <h2>Background</h2>
      <div class="selection-grid">
        <div 
          *ngFor="let background of backgrounds"
          class="selection-card"
          [class.selected]="selectedBackground?.backgroundUuid === background.backgroundUuid"
          (click)="selectBackground(background)"
        >
          <h3>{{ background.name }}</h3>
          <p class="description">{{ background.description }}</p>
        </div>
      </div>
    </div>

    <!-- Race Selection -->
    <div class="section">
      <h2>Race</h2>
      <div class="selection-grid">
        <div 
          *ngFor="let race of races"
          class="selection-card"
          [class.selected]="selectedRace?.raceUuid === race.raceUuid"
          (click)="selectRace(race)"
        >
          <h3>{{ race.name }}</h3>
        </div>
      </div>
    </div>

    <!-- Class Selection -->
    <div class="section">
      <h2>Classes</h2>
      
      <!-- Selected Classes -->
      <div *ngIf="characterDTO.getCharacterClassDetails().length > 0" class="selected-classes">
        <h3>Your Classes (Total Level: {{ getTotalCharacterLevel() }}/20)</h3>
        <div class="class-list">
          <div 
            *ngFor="let classDetail of characterDTO.getCharacterClassDetails(); let i = index"
            class="class-item"
          >
            <div class="class-info">
              <span class="class-name">{{ classDetail.className }}</span>
              <span class="hit-dice">d{{ classDetail.hitDiceValue }}</span>
              <span *ngIf="classDetail.subclassName" class="subclass-name">
                {{ classDetail.subclassName }}
              </span>
              <span *ngIf="!classDetail.subclassName && hasSubClasses(classDetail.classUuid)" class="no-subclass">
                No Subclass
              </span>
            </div>
            
            <!-- Subclass selector for added classes -->
            <div *ngIf="hasSubClasses(classDetail.classUuid)" class="subclass-selector">
              <select 
                [(ngModel)]="classDetail.subclassUuid"
                (change)="onSelectedClassSubclassChange(i, $event)"
                class="subclass-select-small"
              >
                <option value="">-- Select Subclass --</option>
                <option 
                  *ngFor="let subClass of getSubClassesForClass(classDetail.classUuid)"
                  [value]="subClass.subclassUuid"
                >
                  {{ subClass.name }}
                </option>
              </select>
            </div>
            
            <div class="level-controls">
              <button 
                class="btn btn-secondary btn-sm"
                (click)="updateClassLevel(i, classDetail.level - 1)"
                [disabled]="classDetail.level <= 1"
              >-</button>
              <input 
                type="number" 
                [value]="classDetail.level"
                (change)="onClassLevelChange(i, $event)"
                min="1" max="20"
                class="level-input"
              />
              <button 
                class="btn btn-secondary btn-sm"
                (click)="updateClassLevel(i, classDetail.level + 1)"
                [disabled]="classDetail.level >= 20 || getTotalCharacterLevel() >= 20"
              >+</button>
            </div>
            <button 
              class="btn btn-danger btn-sm"
              (click)="removeClass(i)"
              title="Remove class"
            >√ó</button>
          </div>
        </div>
      </div>

      <!-- Add Classes -->
      <div *ngIf="getTotalCharacterLevel() < 20">
        <h3>{{ characterDTO.getCharacterClassDetails().length === 0 ? 'Choose Classes' : 'Add More Classes' }}</h3>
        <div class="selection-grid">
          <div 
            *ngFor="let dndClass of classes"
            class="selection-card class-card"
            [class.disabled]="isClassSelected(dndClass.classUuid)"
          >
            <h3>{{ dndClass.name }}</h3>
            <p class="description">{{ dndClass.description }}</p>
            <div class="hit-dice-info">
              <span>üé≤ Hit Die: d{{ dndClass.hitDiceValue }}</span>
            </div>
            
            <!-- Show message if already selected -->
            <div *ngIf="isClassSelected(dndClass.classUuid)" class="already-selected">
              Already Selected
            </div>
            
            <!-- Subclass Dropdown and Add Button -->
            <div *ngIf="!isClassSelected(dndClass.classUuid)" class="class-selection-controls">
              <!-- Subclass dropdown if class has subclasses -->
              <div *ngIf="hasSubClasses(dndClass.classUuid)" class="subclass-dropdown">
                <label>Choose subclass:</label>
                <select 
                  [(ngModel)]="selectedSubClassForClass[dndClass.classUuid]"
                  class="subclass-select"
                  (click)="$event.stopPropagation()"
                >
                  <option value="">-- Select Subclass --</option>
                  <option 
                    *ngFor="let subClass of getSubClassesForClass(dndClass.classUuid)"
                    [value]="subClass.subclassUuid"
                  >
                    {{ subClass.name }}
                  </option>
                </select>
              </div>
              
              <!-- Add button -->
              <button 
                class="btn btn-primary btn-sm add-class-btn"
                (click)="addClass(dndClass); $event.stopPropagation()"
                [disabled]="!canAddClass(dndClass)"
              >
                Add {{ dndClass.name }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="getTotalCharacterLevel() >= 20" class="max-level-warning">
        ‚ö†Ô∏è Maximum character level (20) reached.
      </div>
    </div>

    <!-- Ability Scores -->
    <div class="section">
      <h2>Ability Scores</h2>
      <div class="ability-scores-grid">
        <div *ngFor="let ability of abilityScoreKeys" class="ability-card">
          <label>{{ ability }}</label>
          <div class="score-controls">
            <button 
              class="btn btn-secondary btn-sm"
              (click)="updateAbilityScore(ability, getAbilityScore(ability) - 1)"
              [disabled]="getAbilityScore(ability) <= 1"
            >-</button>
            <input 
              type="number" 
              [value]="getAbilityScore(ability)"
              (change)="onAbilityScoreChange(ability, $event)"
              min="1" max="20"
              class="score-input"
            />
            <button 
              class="btn btn-secondary btn-sm"
              (click)="updateAbilityScore(ability, getAbilityScore(ability) + 1)"
              [disabled]="getAbilityScore(ability) >= 20"
            >+</button>
          </div>
          <div class="modifier">
            {{ getAbilityModifier(ability) >= 0 ? '+' : '' }}{{ getAbilityModifier(ability) }}
          </div>
        </div>
      </div>
    </div>

    <!-- Character Summary -->
    <div class="section">
      <h2>Character Summary</h2>
      <div class="summary-card">
        <div class="summary-row">
          <span>Name:</span>
          <span>{{ characterDTO.name || 'Unnamed Character' }}</span>
        </div>
        <div class="summary-row">
          <span>Background:</span>
          <span>{{ selectedBackground?.name || 'None selected' }}</span>
        </div>
        <div class="summary-row">
          <span>Race:</span>
          <span>{{ selectedRace?.name || 'None selected' }}</span>
        </div>
        <div class="summary-row">
          <span>Classes:</span>
          <span>
            <span *ngFor="let classDetail of characterDTO.getCharacterClassDetails(); let i = index">
              {{ classDetail.className }} {{ classDetail.level }}
              <span *ngIf="classDetail.subclassName">
                ({{ classDetail.subclassName }})
              </span>{{ i < characterDTO.getCharacterClassDetails().length - 1 ? ', ' : '' }}
            </span>
            <span *ngIf="characterDTO.getCharacterClassDetails().length === 0">None selected</span>
          </span>
        </div>
        <div class="summary-row">
          <span>Total Level:</span>
          <span>{{ getTotalCharacterLevel() }}</span>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions">
      <button class="btn btn-danger" (click)="reset()">Reset</button>
      <button 
        class="btn btn-success btn-lg" 
        (click)="createCharacter()"
        [disabled]="isSaving || !isFormValid()"
      >
        <span *ngIf="!isSaving">‚ú® Create Character</span>
        <span *ngIf="isSaving">Creating...</span>
      </button>
    </div>
  </div>
</div>