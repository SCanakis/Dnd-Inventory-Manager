<div class="character-stats-container">
  <app-basic-character-info-component></app-basic-character-info-component>
  <app-nav-component></app-nav-component>

  <div class="stats-header">
    <h2>Character Statistics</h2>
    <button class="btn btn-primary update-button" (click)="openUpdateModal()">
      Update Character
    </button>
  </div>

  <div *ngIf="characterInfo" class="character-stats-content">
    
    <!-- New Layout: Ability Scores on Left, HP/Death Saves + Basic Info on Right -->
    <div class="ability-hp-death-container">
      
      <!-- Ability Scores Section - Left Side -->
      <div class="stats-section">
        <h3>Ability Scores</h3>
        <div class="ability-scores-grid">
          <div *ngFor="let ability of getAbilityScoreKeys()" class="ability-score-card">
            <div class="ability-name">{{ ability | titlecase }}</div>
            <div class="ability-score">{{ getAbilityScore(ability) }}</div>
            <div class="ability-modifier">
              {{ getAbilityScorePositive(ability) }}{{ getAbilityScoreModifier(ability) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side Container - HP/Death Saves + Basic Info -->
      <div class="right-column">
        <!-- HP and Death Saves Section -->
        <div class="stats-section hp-death-section">
          <h3>Hit Points & Death Saves</h3>
          <div class="hp-death-saves-grid">
            
            <!-- HP Section - Now Editable -->
            <div class="hp-section">
              <h4>Hit Points</h4>
              <div class="hp-display">
                <div class="hp-item editable-item">
                  <span class="hp-label">Current HP:</span>
                  <div class="editable-value">
                    <input 
                      type="number" 
                      class="inline-input hp-input"
                      [(ngModel)]="characterInfo.hpHandler.currentHp"
                      (blur)="onHpChange('current', characterInfo.hpHandler.currentHp)"
                      (keydown.enter)="onHpChange('current', characterInfo.hpHandler.currentHp)"
                      min="0"
                      [max]="characterInfo.hpHandler.maxHp">
                    <span class="hp-value current-hp">{{ characterInfo.hpHandler.currentHp }}</span>
                  </div>
                </div>
                <div class="hp-item">
                  <span class="hp-label">Max HP:</span>
                  <span class="hp-value max-hp">{{ characterInfo.hpHandler.maxHp }}</span>
                </div>
                <div class="hp-item editable-item">
                  <span class="hp-label">Temporary HP:</span>
                  <div class="editable-value">
                    <input 
                      type="number" 
                      class="inline-input hp-input"
                      [(ngModel)]="characterInfo.hpHandler.temporaryHp"
                      (blur)="onHpChange('temp', characterInfo.hpHandler.temporaryHp || 0)"
                      (keydown.enter)="onHpChange('temp', characterInfo.hpHandler.temporaryHp || 0)"
                      min="0"
                      placeholder="0">
                    <span class="hp-value temp-hp">{{ characterInfo.hpHandler.temporaryHp || 0 }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Death Saves Section - Now Editable -->
            <div class="death-saves-section">
              <h4>Death Saving Throws</h4>
              <div class="death-saves-display">
                <div class="save-type editable-saves">
                  <span class="save-label">Successes:</span>
                  <div class="save-controls">
                    <div class="save-dots">
                      <span *ngFor="let i of [1,2,3]" 
                            class="save-dot clickable-dot" 
                            [class.filled]="i <= characterInfo.deathSavingThrowsHelper.successes"
                            [class.success]="i <= characterInfo.deathSavingThrowsHelper.successes"
                            (click)="onDeathSaveChange('successes', i)">
                      </span>
                    </div>
                    <button class="reset-btn" (click)="onDeathSaveChange('successes', 0)" title="Reset">↻</button>
                  </div>
                </div>
                <div class="save-type editable-saves">
                  <span class="save-label">Failures:</span>
                  <div class="save-controls">
                    <div class="save-dots">
                      <span *ngFor="let i of [1,2,3]" 
                            class="save-dot clickable-dot" 
                            [class.filled]="i <= characterInfo.deathSavingThrowsHelper.failures"
                            [class.failure]="i <= characterInfo.deathSavingThrowsHelper.failures"
                            (click)="onDeathSaveChange('failures', i)">
                      </span>
                    </div>
                    <button class="reset-btn" (click)="onDeathSaveChange('failures', 0)" title="Reset">↻</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Basic Info Section - Inspiration Now Editable -->
        <div class="stats-section basic-info-compact">
          <h3>Basic Information</h3>
          <div class="basic-info-grid">
            <div class="info-item">
              <span class="info-label">Name:</span>
              <span class="info-value">{{ characterInfo.name }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Race:</span>
              <span class="info-value">{{ characterInfo.race }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Background:</span>
              <span class="info-value">{{ characterInfo.background }}</span>
            </div>
            <div class="info-item editable-item">
              <span class="info-label">Inspiration:</span>
              <div class="inspiration-toggle">
                <input 
                  type="checkbox" 
                  id="inspiration-toggle"
                  class="inspiration-checkbox"
                  [(ngModel)]="characterInfo.inspiration"
                  (change)="onInspirationChange(characterInfo.inspiration)">
                <label for="inspiration-toggle" class="inspiration-label">
                  <span class="info-value" [class.inspiration-active]="characterInfo.inspiration">
                    {{ characterInfo.inspiration ? 'Yes' : 'No' }}
                  </span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Classes Section - Hit Dice Now Editable -->
    <div class="stats-section">
      <h3>Classes</h3>
      <div class="classes-list">
        <div *ngFor="let characterClass of characterInfo.classes; let i = index" class="class-card">
          <div class="class-header">
            <span class="class-name">{{ characterClass.className }}</span>
            <span class="class-level">Level {{ characterClass.level }}</span>
          </div>
          <div class="class-details">
            <div class="class-detail-item">
              <span class="detail-label">Subclass:</span>
              <span class="detail-value">{{ characterClass.subclassName || 'None' }}</span>
            </div>
            <div class="class-detail-item">
              <span class="detail-label">Hit Dice:</span>
              <span class="detail-value">d{{ characterClass.hitDiceValue }}</span>
            </div>
            <div class="class-detail-item editable-item">
              <span class="detail-label">Hit Dice Remaining:</span>
              <div class="hit-dice-controls">
                <button 
                  class="dice-btn minus-btn" 
                  (click)="onHitDiceChange(i, characterClass.hitDiceRemaining - 1)"
                  [disabled]="characterClass.hitDiceRemaining <= 0">
                  −
                </button>
                <input 
                  type="number" 
                  class="inline-input dice-input"
                  [(ngModel)]="characterClass.hitDiceRemaining"
                  (blur)="onHitDiceChange(i, characterClass.hitDiceRemaining)"
                  (keydown.enter)="onHitDiceChange(i, characterClass.hitDiceRemaining)"
                  min="0" 
                  [max]="characterClass.level">
                <button 
                  class="dice-btn plus-btn" 
                  (click)="onHitDiceChange(i, characterClass.hitDiceRemaining + 1)"
                  [disabled]="characterClass.hitDiceRemaining >= characterClass.level">
                  +
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Loading state -->
  <div *ngIf="!characterInfo" class="loading-state">
    <p>Loading character statistics...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="!characterInfo && charUuid" class="error-state">
    <p>Unable to load character statistics. Please try again.</p>
    <button class="btn btn-primary" (click)="loadCharacterStats()">Retry</button>
  </div>
</div>

<!-- Update Character Modal -->
<div *ngIf="showUpdateModal" class="modal-overlay" (click)="closeUpdateModal()">
  <div class="modal-content update-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Update Character Information</h3>
      <button class="close-button" (click)="closeUpdateModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form class="update-form">
        <!-- Basic Information Section -->
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-grid">
            <div class="form-group">
              <label for="characterName">Character Name</label>
              <input 
                type="text" 
                id="characterName"
                [(ngModel)]="updateData.name"
                name="characterName"
                class="form-control">
            </div>
            
            <div class="form-group">
              <label for="characterInspiration">Inspiration</label>
              <div class="checkbox-container">
                <input 
                  type="checkbox" 
                  id="characterInspiration"
                  [(ngModel)]="updateData.inspiration"
                  name="characterInspiration"
                  class="form-checkbox">
                <span class="checkmark"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Ability Scores Section -->
        <div class="form-section">
          <h4>Ability Scores</h4>
          <div class="ability-scores-form-grid">
            <div *ngFor="let ability of getAbilityScoreKeys()" class="form-group">
              <label [for]="'ability-' + ability">{{ ability | titlecase }}</label>
              <input 
                type="number" 
                [id]="'ability-' + ability"
                [ngModel]="updateData.abilityScores[ability] || 0"
                (ngModelChange)="updateAbilityScore(ability, $event)"
                [name]="'ability-' + ability"
                min="1" 
                max="30"
                class="form-control ability-input">
            </div>
          </div>
        </div>

        <!-- Hit Points Section -->
        <div class="form-section">
          <h4>Hit Points</h4>
          <div class="form-grid">
            <div class="form-group">
              <label for="currentHp">Current HP</label>
              <input 
                type="number" 
                id="currentHp"
                [(ngModel)]="updateData.hpHandler!.currentHp"
                name="currentHp"
                min="0"
                class="form-control">
            </div>
            
            <div class="form-group">
              <label for="maxHp">Max HP</label>
              <input 
                type="number" 
                id="maxHp"
                [(ngModel)]="updateData.hpHandler!.maxHp"
                name="maxHp"
                min="1"
                class="form-control">
            </div>
            
            <div class="form-group">
              <label for="temporaryHp">Temporary HP</label>
              <input 
                type="number" 
                id="temporaryHp"
                [(ngModel)]="updateData.hpHandler!.temporaryHp"
                name="temporaryHp"
                min="0"
                class="form-control">
            </div>
          </div>
        </div>

        <!-- Death Saving Throws Section -->
        <div class="form-section">
          <h4>Death Saving Throws</h4>
          <div class="death-saves-form">
            <div class="form-group">
              <label for="deathSaveSuccesses">Successes</label>
              <input 
                type="number" 
                id="deathSaveSuccesses"
                [(ngModel)]="updateData.deathSavingThrowsHelper!.successes"
                name="deathSaveSuccesses"
                min="0" 
                max="3"
                class="form-control">
            </div>
            
            <div class="form-group">
              <label for="deathSaveFailures">Failures</label>
              <input 
                type="number" 
                id="deathSaveFailures"
                [(ngModel)]="updateData.deathSavingThrowsHelper!.failures"
                name="deathSaveFailures"
                min="0" 
                max="3"
                class="form-control">
            </div>
          </div>
        </div>

        <!-- NEW: Classes Section -->
        <div class="form-section">
          <h4>Classes & Levels</h4>
          <div class="classes-form-section">
            <div *ngFor="let characterClass of updateData.characterClassDetail; let i = index" 
                 class="class-form-group">
              <h5>{{ characterClass.className }}</h5>
              <div class="class-form-grid">
                <div class="form-group">
                  <label [for]="'class-level-' + i">Level</label>
                  <div class="level-input-container">
                    <button 
                      type="button"
                      class="level-btn minus-btn" 
                      (click)="updateClassLevel(i, characterClass.level - 1)"
                      [disabled]="characterClass.level <= 1 || getTotalLevel() >= 20 && characterClass.level === 1">
                      −
                    </button>
                    <input 
                      type="number" 
                      [id]="'class-level-' + i"
                      [(ngModel)]="characterClass.level"
                      (ngModelChange)="onClassLevelChangeInModal(i, $event)"
                      [name]="'class-level-' + i"
                      min="1" 
                      max="20"
                      class="form-control level-input">
                    <button 
                      type="button"
                      class="level-btn plus-btn" 
                      (click)="updateClassLevel(i, characterClass.level + 1)"
                      [disabled]="characterClass.level >= 20 || getTotalLevel() >= 20">
                      +
                    </button>
                  </div>
                </div>
                
                <div class="form-group">
                  <label [for]="'hit-dice-remaining-' + i">Hit Dice Remaining</label>
                  <input 
                    type="number" 
                    [id]="'hit-dice-remaining-' + i"
                    [(ngModel)]="characterClass.hitDiceRemaining"
                    [name]="'hit-dice-remaining-' + i"
                    min="0" 
                    [max]="characterClass.level"
                    class="form-control">
                </div>
                
                <!-- NEW: Subclass Selection -->
                <div class="form-group">
                  <label [for]="'subclass-' + i">Subclass</label>
                  <div *ngIf="getSubClassesForClass(characterClass.classUuid).length > 0; else noSubclassTemplate">
                    <select 
                      [id]="'subclass-' + i"
                      [(ngModel)]="characterClass.subclassUuid"
                      (ngModelChange)="onSubclassChangeInModal(i, $event)"
                      [name]="'subclass-' + i"
                      class="form-control subclass-select">
                      <option value="">-- No Subclass --</option>
                      <option 
                        *ngFor="let subClass of getSubClassesForClass(characterClass.classUuid)"
                        [value]="subClass.subclassUuid">
                        {{ subClass.name }}
                      </option>
                    </select>
                  </div>
                  <ng-template #noSubclassTemplate>
                    <div class="no-subclass-available">
                      <span class="class-info-display">
                        <span class="class-subclass">No subclasses available</span>
                        <span class="hit-dice-info">Hit Die: d{{ characterClass.hitDiceValue }}</span>
                      </span>
                    </div>
                  </ng-template>
                </div>
              </div>
            </div>
            
            <div class="total-level-display">
              <strong>Total Character Level: {{ getTotalLevel() }}/20</strong>
              <span *ngIf="getTotalLevel() > 20" class="level-warning">
                ⚠️ Total level exceeds maximum (20)
              </span>
            </div>
          </div>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button 
        class="btn btn-primary" 
        (click)="saveCharacterUpdates()"
        [disabled]="!isValidUpdate()">
        Save Changes
      </button>
      <button class="btn btn-secondary" (click)="closeUpdateModal()">
        Cancel
      </button>
    </div>
  </div>
</div>